<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo List W12</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/5c062f800e.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script>
    let title = ""
    let id = 1
    let uncompletedCount = 0

    $(document).ready(() => {
      const BASE_URL = 'https://mentor-program.co/mtr04group3/dingding/week12/hw2/'
      const todoContainer = $('.todo__container')

      let dataSave = JSON.parse(localStorage.getItem('title'))
      if (dataSave) {
        dataSave.forEach((item) => {
          showTodoBtn(item.listTitle)
        })
      } else if (!dataSave) {
        dataSave = []
      }

      // 輸入Todolist標題
      $('.title__input').keypress((e) => {
        if (e.which === 13) {
          title = inputKeyIn($('input[name=todolist__title]'))
          $('.title__input').removeClass('d-flex').hide()
          $('.card__title').text(title)
          $('input[name=todolist__title]').val('')
        }
      })

      // 輸入Todolist內容
      $('.items__input').keypress((e) => {
        if (e.which === 13) {
          addTodo(todoContainer, inputKeyIn($('input[name=todo_content]')))
          $('input[name=todo_content]').val("")
          id += 1
          uncompletedCount++
          updateUncompletedCount(uncompletedCount)
        }
      })

      // 完成與未完成的切換
      todoContainer.on('click', '.fa-check-circle', (e) => {
        const targetItem = $(e.target).parent().parent()
        if ($('.todo_list', targetItem).hasClass('done')) {
          uncompletedCount++
        } else {
          uncompletedCount--
        }
        $('.todo_list', targetItem).toggleClass('done')
        $(e.target).toggleClass('doneicon')
        updateUncompletedCount(uncompletedCount)
      })

      // 刪除
      todoContainer.on('click', '.fa-trash-alt', (e) => {
        const targetItem = $(e.target).parent().parent()
        targetItem.remove()
        if (!$('.todo_list', targetItem).hasClass('done')) {
          uncompletedCount--
        }
        updateUncompletedCount(uncompletedCount)
      })

      // 顯示全部內容
      $('.btn_all').click(() => {
        let target = $('.todo_list').parent().parent()
        target.addClass('d-flex')
      })

      // 顯示未完成內容
      $('.btn_active').click(() => {
        let todoTarget = $('.todo_list').parent().parent()
        let doneTarget = $('.todo_list.done').parent().parent()
        todoTarget.addClass('d-flex').show()
        doneTarget.removeClass('d-flex').hide()
      })

      // 顯示已完成內容
      $('.btn_completed').click(() => {
        let todoTarget = $('.todo_list').parent().parent()
        let doneTarget = $('.todo_list.done').parent().parent()
        todoTarget.removeClass('d-flex').hide()
        doneTarget.addClass('d-flex').show()
      })

      // 刪除已完成內容
      $('.btn_delete_completed').click(() => {
        let doneTarget = $('.todo_list.done').parent().parent()
        doneTarget.remove()
      })

      // 修改內容
      todoContainer.on('click', '.fa-pen', (e) => {
        const input = $(e.target).parent().parent().find('input')
        const originTodo = $(e.target).parent().find('.todo_list')
        input.show()
        input.keypress((e) => {
          if (e.which === 13) {
            const newtodo = input.val().trim()
            if (!newtodo) {
              return
            }
            originTodo.text(escapeHtml(newtodo))
            input.hide()
          }
        })
      })

      // 新增Todolist
      $('.btn-new').click(() => {
        title = ''
        uncompletedCount = 0
        id = 1
        $('.card__title').text('')
        $('.title__input').addClass('d-flex').show()
        todoContainer.empty()
        updateUncompletedCount(uncompletedCount)
        if (!$('.btn-save').hasClass('d-flex')) {
          $('.btn-save').addClass('d-flex').show()
        }
        $('.btn-update').removeClass('d-flex').hide()
      })

      // 儲存Todolist
      $('.btn-save').click(() => {
        if (!title) {
          alert('please inout your TITLE')
          return
        }
        $.ajax({
          type: 'POST',
          url: BASE_URL + 'saveapi.php',
          data: {
            title: title,
            todo: getTodoData()
          },
          success: function (resp) {
            console.log(resp)
          },
          error: function () {
            alert('!!')
          }
        })
        dataSave.push({
          'listTitle': title
        })
        const result = JSON.stringify(dataSave)
        localStorage.setItem('title', result)
        $('.btn-update').addClass('d-flex').show()
        $('.btn-save').removeClass('d-flex').hide()
        showTodoBtn(title)
      })

      // 儲存被修改的Todolist
      $('.btn-update').click(() => {
        title = $('.card__title').text()
        let todoItems = []
        $('.todo_list_item').each((i, element) => {
          const itemId = $('.todo_list_item')[i].id
          const isDone = $(element).find('.todo_list').hasClass('done')
          content = $(element).find('.todo_list').text()
          let completed = 1
          if (!isDone) {
            completed = 2
          }
          todoItems.push({
            'id': itemId,
            'content': content,
            'is_done': completed
          })
        })
        const data = JSON.stringify(todoItems)
        $.ajax({
          type: 'POST',
          url: BASE_URL + 'updateapi.php',
          data: {
            title: title,
            todo: data
          },
          success: function (resp) {
            console.log(resp)
          },
          error: function () {
            alert('!!')
          }
        })
      })

      // 顯示已儲存的Todolist
      $('.side__bar').on('click', '.btn-list', (e) => {
        title = $(e.target).text()
        $.ajax({
          type: 'GET',
          url: BASE_URL + 'getapi.php?title=' + title,
          success: function (resp) {
            showSaveTodoList(todoContainer, resp.data)
          },
          error: function () {
            alert('!!')
          }
        })
        $('.btn-update').addClass('d-flex').show()
        $('.btn-save').removeClass('d-flex').hide()
      })
    })

    function getHTML(id, todo) {
      const html = `
        <li class="todo_list_item list-group-item d-flex flex-row justify-content-between" id="${id}">
  <div class="d-flex p-1">
    <div class="todo_list {todoclass}">${escapeHtml(todo)}</div>
    <i type="button" class="fas fa-pen fa-md p-1"></i>
  </div>
  <input class="edit_todo" style="display:none" type="text" name="todo" value="${escapeHtml(todo)}">
  <div class="todo__btn d-flex p-2">
    <i class="far fa-check-circle {checkclass} fa-md"></i>
    <i class="far fa-trash-alt fa-md px-2"></i>
  </div>
</li>
      `
      return html
    }


    function addTodo(container, todo) {
      container.append(getHTML(id, todo))
    }

    function showSaveTodoList(container, data) {
      uncompletedCount = 0
      const title = data.title
      console.log(title)
      container.empty()
      $('.card__title').text(title)
      const todos = JSON.parse(data.content)
      todos.forEach(todo => {
        if (todo.is_done === 2) {
          uncompletedCount++
          container.append(
            getHTML(todo.id, todo.content)
              .replace('{todoclass}', '')
              .replace('{checkclass}', ''))
        } else if (todo.is_done === 1) {
          container.append(
            getHTML(todo.id, todo.content)
              .replace('{todoclass}', 'done')
              .replace('{checkclass}', 'doneicon'))
        }
      })
      if ($('.title__input').hasClass('d-flex')) {
        $('.title__input').removeClass('d-flex').hide()
      }
      updateUncompletedCount(uncompletedCount)
    }

    function getTodoData() {
      let todoItems = []
      $('.todo_list_item').each((i, element) => {
        const itemId = $('.todo_list_item')[i].id
        const isDone = $(element).find('.todo_list').hasClass('done')
        content = $(element).find('.todo_list').text()
        let completed = 1
        if (!isDone) {
          completed = 2
        }
        todoItems.push({
          'id': itemId,
          'content': content,
          'is_done': completed
        })
      })
      const data = JSON.stringify(todoItems)
      return data
    }

    function showTodoBtn(title) {
      const sideBar = $('.side__bar')
      const newBtn = `
      <div class='d-flex justify-content-center'>
          <button type="button" class="btn btn-outline-secondary btn-list m-2">${escapeHtml(title)}</button>
        </div>
      `
      sideBar.append(newBtn)
    }

    function inputKeyIn(inputTarget) {
      const value = inputTarget.val().trim()
      if (!value) {
        alert('Please input your field')
        inputTarget.val("")
        return
      }
      return value
    }

    function updateUncompletedCount(uncompletedCount) {
      let uncomplete = ""
      if (uncompletedCount > 1) {
        uncomplete = `${uncompletedCount} items uncompleted`
      } else {
        uncomplete = `${uncompletedCount} item uncompleted`
      }
      $('.uncomplete-count').text(uncomplete)
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</head>

<body>
  <header class="navbar sticky-top bg-secondary p-3 px-0 shadow">
    <div class="navbar-brand fs-2 m-1 px-3 w-100">Todo List</div>
  </header>
  <main class="container-fluid">
    <div class="main__site row">
      <div class="side__bar col-sm-3 col-md-2 bg-white">
        <div class='d-flex justify-content-center'>
          <button type="button" class="btn btn-outline-secondary btn-new mt-5">New Todo</button>
        </div>
      </div>
      <div class="main__card col-sm-9 col-md-10 bg-light d-flex flex-column align-items-center">
        <div class="todos__inputs col-sm-12">
          <div class="title__input m-3 d-flex justify-content-between">
            <input type="text" name="todolist__title" class="form-control" placeholder="Enter your todolist name">
          </div>
          <div class="items__input m-3 d-flex justify-content-between">
            <input type="text" name="todo_content" class="form-control" placeholder="What needs to be done?">
          </div>
        </div>
        <div class="card todos__card mt-3" style="width:80%;">
          <div class="card-header d-flex justify-content-center">
            <div class="card__title text-center"></div>
          </div>
          <ul class="todo__container list-group list-group-flush d-flex">
            <!-- todo items -->
          </ul>
          <div class="card-footer d-flex flex-row justify-content-between">
            <div class="uncomplete-count container-fluid p-1"></div>
            <div class="container-fluid">
              <button type="button" class="btn btn-outline-secondary btn-sm row p-1 mx-1 btn_all">All</button>
              <button type="button" class="btn btn-outline-secondary btn-sm row p-1 mx-1 btn_active">Active</button>
              <button type="button"
                class="btn btn-outline-secondary btn-sm row p-1 mx-1 btn_completed">Completed</button>
            </div>
            <button class="clear_completed container-fluid btn btn-light btn-sm p-1 btn_delete_completed">Clear
              completed</button>
          </div>
        </div>
        <div class="d-flex justify-content-center m-4">
          <button type="button" class="btn btn-outline-secondary btn-save mx-3 d-flex">SAVE</button>
          <button type="button" class="btn btn-outline-secondary btn-update" style="display: none">UPDATE</button>
        </div>
      </div>
    </div>

  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
</body>

</html>