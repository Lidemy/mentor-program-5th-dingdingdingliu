<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Message Board</title>
  <style>
    * {
      box-sizing: border-box;
    }

    section {
      display: flex;
      flex-direction: column;
    }

    .btn_more {
      margin: 5px auto;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script>
    function encodeHTML(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
    }

    function addCommentToDom(container, comment) {
      const html = `
        <div class="card text-center mb-3">
          <div class="card-header text-muted p-1">${comment.id} nickname: ${encodeHTML(comment.nickname)}</div>
          <div class="card-body">
            <p class="card-text p-2">${encodeHTML(comment.content)}</p>
          </div>
          <div class="card-footer text-muted p-1">
            ${encodeHTML(comment.created_at)}
          </div>
          <input type="hidden" value="${comment.id}">
        </div>
      `
      container.append(html)
    }

    function showComments(container, messages) {
      const messagesLength = messages.length
      if (messagesLength <= 5) {
        messages.forEach(message => {
          addCommentToDom(container, message)
        })
        $('.btn_more').hide()
      } else {
        for (let i = 0; i < messagesLength - 1; i++) {
          addCommentToDom(container, messages[i])
        }
      }
    }

    $(document).ready(() => {
      const BASE_URL = 'https://mentor-program.co/mtr04group3/dingding/week12/hw1/'
      let cursor = 0
      let length = 0
      const textContainer = $('.text_container')
      $.ajax({
        url: BASE_URL + 'getmessage_api.php?site_key=ding'
      }).done((data) => {
        if (!data.result) {
          return alert(data.message)
        }
        const messages = data.messages
        showComments(textContainer, messages)
        length = messages.length
        cursor = messages[length - 2].id
      })

      $('.form_container').submit(e => {
        e.preventDefault()
        const addCommentData = {
          'site_key': 'ding',
          'nickname': $('input[name=nickname]').val(),
          'content': $('textarea[name=content]').val()
        }
        $.ajax({
          type: 'POST',
          url: BASE_URL + 'addmessage_api.php',
          data: addCommentData
        }).done(function (data) {
          if (!data.result) {
            alert(data.message)
            return
          }
          alert(data.message)
          location.reload()
        });
      })

      $('.btn_get_more').click(() => {
        $.ajax({
          url: `${BASE_URL}getmessage_api.php?site_key=ding&cursor=${cursor}`
        }).done((data) => {
          if (!data.result) {
            return alert(data.message)
          }
          const messages = data.messages
          showComments(textContainer, messages)
          length = messages.length
          cursor = messages[length - 2].id
        })
      })
    })
  </script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light p-1">
    <div class="container-fluid">
      <a class="navbar-brand m-2" href="#">留言板</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav m-2">
          <a class="nav-link active m-1" aria-current="page" href="#">Home</a>
          <a class="nav-link m-1" href="#">Features</a>
          <a class="nav-link m-1" href="#">Pricing</a>
          <!-- <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a> -->
        </div>
      </div>
    </div>
  </nav>
  <section class="p-2 px-5">
    <form class="form_container mb-5 px-5">
      <div class="mb-2">
        <label for="form-nickname" class="form-label">Nickname:</label>
        <input name="nickname" type="text" class="form-control" placeholder="Your nickname" id="form-nickname">
      </div>
      <div class="mb-2">
        <label for="form-content" class="form-label">Message: </label>
        <textarea name="content" class="form-control" id="form-content" rows="5" placeholder="Leave message"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">送出</button>
    </form>
    <div class="text_container mb-4 px-5">
      <!-- card-content -->
    </div>
    <div class="btn_more">
      <button type="button" class="btn btn-outline-secondary btn_get_more">MORE</button>
    </div>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
</body>

</html>